class PerformanceOptimizer{constructor(){this.lazyLoadObserver=null,this.intersectionObserver=null,this.mutationObserver=null,this.performanceMetrics={},this.domUpdateQueue=[],this.isProcessingQueue=!1,this.lastFrameTime=0,this.frameCount=0,this.fps=0,this.init()}init(){this.setupLazyLoading(),this.setupDOMOptimization(),this.setupPerformanceMonitoring(),this.setupResourceOptimization(),this.setupMemoryManagement(),this.setupRealTimeOptimization(),this.setupImageOptimization(),this.setupCriticalResourcePreloading()}setupLazyLoading(){this.lazyLoadObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.loadLazyElement(e.target)})},{rootMargin:"50px 0px",threshold:[0,.1,.5,1]}),this.observeLazyElements(),this.setupComponentLazyLoading()}observeLazyElements(){document.querySelectorAll('img[data-src], img[loading="lazy"]').forEach(e=>{this.lazyLoadObserver.observe(e)}),document.querySelectorAll("[data-bg-src]").forEach(e=>{this.lazyLoadObserver.observe(e)}),document.querySelectorAll("iframe[data-src]").forEach(e=>{this.lazyLoadObserver.observe(e)}),document.querySelectorAll("[data-lazy-component]").forEach(e=>{this.lazyLoadObserver.observe(e)})}loadLazyElement(e){switch(e.dataset.priority||"normal"){case"high":this.loadElementImmediate(e);break;case"low":this.scheduleElementLoad(e,1e3);break;default:this.scheduleElementLoad(e,100)}this.lazyLoadObserver.unobserve(e)}loadElementImmediate(e){"IMG"===e.tagName&&e.dataset.src?this.loadImage(e):e.dataset.bgSrc?this.loadBackgroundImage(e):"IFRAME"===e.tagName&&e.dataset.src?this.loadIframe(e):e.dataset.lazyComponent&&this.loadComponent(e)}scheduleElementLoad(e,t){setTimeout(()=>{this.loadElementImmediate(e)},t)}loadImage(e){const t=new Image;t.onload=()=>{e.src=t.src,e.classList.add("loaded"),e.removeAttribute("data-src")},t.onerror=()=>{e.classList.add("error"),e.alt="Failed to load image"},t.src=e.dataset.src}loadBackgroundImage(e){const t=new Image;t.onload=()=>{e.style.backgroundImage=`url(${t.src})`,e.classList.add("bg-loaded"),e.removeAttribute("data-bg-src")},t.src=e.dataset.bgSrc}loadIframe(e){e.src=e.dataset.src,e.removeAttribute("data-src")}loadComponent(e){const t=e.dataset.lazyComponent;switch(t){case"chart":this.loadChartComponent(e);break;case"table":this.loadTableComponent(e);break;case"lottie":this.loadLottieComponent(e);break;default:console.warn("Unknown lazy component type:",t)}}setupComponentLazyLoading(){this.intersectionObserver=new IntersectionObserver(e=>{e.forEach(e=>{e.isIntersecting&&this.loadVisibleComponent(e.target)})},{rootMargin:"100px 0px",threshold:.1}),document.querySelectorAll(".chart-container, .data-table, .lottie-animation").forEach(e=>{e.dataset.loaded||this.intersectionObserver.observe(e)})}loadVisibleComponent(e){e.classList.contains("chart-container")?this.loadChartComponent(e):e.classList.contains("data-table")?this.loadTableComponent(e):e.classList.contains("lottie-animation")&&this.loadLottieComponent(e),this.intersectionObserver.unobserve(e)}loadChartComponent(e){e.dataset.loaded||(e.dataset.loaded="true",this.showComponentLoader(e,"Loading chart..."),requestIdleCallback(()=>{this.initializeChart(e)}))}loadTableComponent(e){if(e.dataset.loaded)return;e.dataset.loaded="true";const t=e.querySelectorAll("tbody tr"),a=this.calculateOptimalBatchSize();this.loadTableInBatches(t,a)}loadLottieComponent(e){if(!e.dataset.loaded&&(e.dataset.loaded="true",window.lottie&&e.dataset.animationPath)){const t=window.lottie.loadAnimation({container:e,renderer:"svg",loop:"true"===e.dataset.loop,autoplay:"true"===e.dataset.autoplay,path:e.dataset.animationPath});e.lottieAnimation=t}}setupDOMOptimization(){this.setupDOMBatching(),this.setupVirtualScrolling(),this.setupEventDelegation(),this.setupMutationOptimization()}setupDOMBatching(){this.domUpdateQueue=[],this.isProcessingQueue=!1,this.processDOMQueue=this.processDOMQueue.bind(this)}queueDOMUpdate(e,t="normal"){this.domUpdateQueue.push({fn:e,priority:t,timestamp:performance.now()}),this.isProcessingQueue||this.scheduleQueueProcessing()}scheduleQueueProcessing(){this.isProcessingQueue=!0,requestAnimationFrame(this.processDOMQueue)}processDOMQueue(){const e=performance.now();for(this.domUpdateQueue.sort((e,t)=>{const a={high:0,normal:1,low:2};return a[e.priority]-a[t.priority]});this.domUpdateQueue.length>0&&performance.now()-e<16;){const e=this.domUpdateQueue.shift();try{e.fn()}catch(e){console.error("DOM update error:",e)}}this.domUpdateQueue.length>0?requestAnimationFrame(this.processDOMQueue):this.isProcessingQueue=!1}setupVirtualScrolling(){document.querySelectorAll("[data-virtual-scroll]").forEach(e=>{this.initializeVirtualScrolling(e)})}initializeVirtualScrolling(e){const t=parseInt(e.dataset.itemHeight)||50,a=Array.from(e.children),s=Math.ceil(e.clientHeight/t)+2;let i=0,o=0;const r=()=>{const e=Math.floor(i/t),r=Math.min(e+s,a.length);if(e!==o){o=e,a.forEach(e=>e.style.display="none");for(let e=o;e<r;e++)a[e]&&(a[e].style.display="",a[e].style.transform=`translateY(${e*t}px)`)}};e.addEventListener("scroll",e=>{i=e.target.scrollTop,requestAnimationFrame(r)}),r()}setupEventDelegation(){["click","touchstart","touchend","mouseover","mouseout"].forEach(e=>{document.addEventListener(e,e=>{this.handleDelegatedEvent(e)},{passive:!0})})}handleDelegatedEvent(e){const t=e.target;t.matches("button, .btn")&&this.handleButtonEvent(e,t),t.matches(".card, .card *")&&this.handleCardEvent(e,t.closest(".card")),t.matches("tr, tr *")&&this.handleTableRowEvent(e,t.closest("tr"))}setupMutationOptimization(){this.mutationObserver=new MutationObserver(e=>{this.handleDOMMutations(e)}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style","data-*"]})}handleDOMMutations(e){const t=this.batchMutations(e);requestIdleCallback(()=>{this.processMutationBatch(t)})}batchMutations(e){const t={added:[],removed:[],modified:[]};return e.forEach(e=>{"childList"===e.type?(t.added.push(...e.addedNodes),t.removed.push(...e.removedNodes)):"attributes"===e.type&&t.modified.push(e.target)}),t}processMutationBatch(e){e.added.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.processAddedElement(e)}),e.removed.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.processRemovedElement(e)}),e.modified.forEach(e=>{this.processModifiedElement(e)})}processAddedElement(e){e.matches("img[data-src], [data-bg-src], [data-lazy-component]")&&this.lazyLoadObserver.observe(e),e.matches(".chart-container, .data-table, .lottie-animation")&&(e.dataset.loaded||this.intersectionObserver.observe(e))}processRemovedElement(e){this.lazyLoadObserver&&this.lazyLoadObserver.unobserve(e),this.intersectionObserver&&this.intersectionObserver.unobserve(e),e.lottieAnimation&&e.lottieAnimation.destroy(),e.chart&&e.chart.destroy()}processModifiedElement(e){"none"===e.style.display||e.hidden?this.pauseElementAnimations(e):this.resumeElementAnimations(e)}setupRealTimeOptimization(){this.dataUpdateQueue=new Map,this.isProcessingDataUpdates=!1,this.lastDataUpdate=0,this.dataUpdateThrottle=100,this.setupDataUpdateBatching()}setupDataUpdateBatching(){this.processDataUpdates=this.processDataUpdates.bind(this)}queueDataUpdate(e,t,a="text"){const s=performance.now();if(this.dataUpdateQueue.has(e)){const a=this.dataUpdateQueue.get(e);if(s-a.timestamp<this.dataUpdateThrottle)return a.data=t,void(a.timestamp=s)}this.dataUpdateQueue.set(e,{data:t,updateType:a,timestamp:s}),this.isProcessingDataUpdates||this.scheduleDataProcessing()}scheduleDataProcessing(){this.isProcessingDataUpdates=!0,requestAnimationFrame(this.processDataUpdates)}processDataUpdates(){const e=performance.now(),t=Array.from(this.dataUpdateQueue.entries());this.dataUpdateQueue.clear();for(const[a,s]of t)performance.now()-e>=8?this.dataUpdateQueue.set(a,s):this.applyDataUpdate(a,s);this.dataUpdateQueue.size>0?requestAnimationFrame(this.processDataUpdates):this.isProcessingDataUpdates=!1}applyDataUpdate(e,t){const a=document.getElementById(e);if(!a)return;const{data:s,updateType:i}=t;switch(i){case"text":a.textContent!==s&&(a.textContent=s);break;case"html":a.innerHTML!==s&&(a.innerHTML=s);break;case"class":a.className=s;break;case"attribute":Object.entries(s).forEach(([e,t])=>{a.setAttribute(e,t)});break;case"style":Object.entries(s).forEach(([e,t])=>{a.style[e]=t})}this.addUpdateAnimation(a)}addUpdateAnimation(e){e.classList.add("data-updated"),setTimeout(()=>{e.classList.remove("data-updated")},300)}setupPerformanceMonitoring(){this.startFPSMonitoring(),this.setupPerformanceObserver(),this.monitorMemoryUsage(),this.trackUserInteractions()}startFPSMonitoring(){const e=t=>{if(this.lastFrameTime){const e=t-this.lastFrameTime;this.fps=Math.round(1e3/e),this.frameCount++,this.fps<30&&this.frameCount%60==0&&(console.warn("Low FPS detected:",this.fps),this.handleLowPerformance())}this.lastFrameTime=t,requestAnimationFrame(e)};requestAnimationFrame(e)}setupPerformanceObserver(){if("PerformanceObserver"in window){const e=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.duration>50&&(console.warn("Long task detected:",e.duration+"ms"),this.handleLongTask(e))})});try{e.observe({entryTypes:["longtask"]})}catch(e){console.log("Long task observer not supported")}const t=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{e.value>.1&&console.warn("Layout shift detected:",e.value)})});try{t.observe({entryTypes:["layout-shift"]})}catch(e){console.log("Layout shift observer not supported")}}}monitorMemoryUsage(){"memory"in performance&&setInterval(()=>{const e=performance.memory,t=e.usedJSHeapSize/e.jsHeapSizeLimit;t>.8&&(console.warn("High memory usage:",Math.round(100*t)+"%"),this.handleHighMemoryUsage())},1e4)}trackUserInteractions(){["click","scroll","keydown","touchstart"].forEach(e=>{document.addEventListener(e,t=>{this.recordInteraction(e,t)},{passive:!0})})}recordInteraction(e,t){const a=performance.now();requestAnimationFrame(()=>{const t=performance.now()-a;t>100&&console.warn(`Slow ${e} response:`,t+"ms")})}handleLowPerformance(){document.body.classList.add("reduced-motion"),this.pauseNonEssentialAnimations(),this.reduceUpdateFrequency()}handleLongTask(e){"self"===e.name&&e.duration>100&&this.deferNonCriticalWork()}handleHighMemoryUsage(){this.clearPerformanceCaches(),this.reduceActiveComponents(),window.gc&&window.gc()}pauseNonEssentialAnimations(){document.querySelectorAll(".lottie-animation").forEach(e=>{e.lottieAnimation&&!this.isElementVisible(e)&&e.lottieAnimation.pause()})}reduceUpdateFrequency(){this.dataUpdateThrottle=200,window.chartUpdateInterval&&(clearInterval(window.chartUpdateInterval),window.chartUpdateInterval=setInterval(window.updateCharts,1e4))}deferNonCriticalWork(){"requestIdleCallback"in window&&requestIdleCallback(()=>{this.processNonCriticalTasks()})}clearPerformanceCaches(){document.querySelectorAll("img").forEach(e=>{!this.isElementVisible(e)&&e.src&&e.removeAttribute("src")}),window.dataCache&&window.dataCache.clear()}reduceActiveComponents(){document.querySelectorAll(".chart-container, .data-table").forEach(e=>{this.isElementVisible(e)||(e.style.visibility="hidden")})}isElementVisible(e){const t=e.getBoundingClientRect();return t.bottom>=0&&t.top<=window.innerHeight}calculateOptimalBatchSize(){const e=navigator.deviceMemory||4,t=navigator.hardwareConcurrency||4;return e<=2||t<=2?10:e>=8&&t>=8?50:25}showComponentLoader(e,t){const a=document.createElement("div");return a.className="component-loader",a.innerHTML=`\n            <div class="loading-spinner">\n                <div class="spinner"></div>\n                <span>${t}</span>\n            </div>\n        `,e.appendChild(a),a}loadTableInBatches(e,t){let a=0;const s=Math.ceil(e.length/t),i=()=>{const o=a*t,r=Math.min(o+t,e.length);for(let t=o;t<r;t++)e[t]&&(e[t].style.display="",e[t].classList.add("loaded"));a++,a<s&&requestIdleCallback(i)};i()}initializeChart(e){const t=e.querySelector(".component-loader");t&&t.remove(),window.initializeChart&&window.initializeChart(e)}checkLazyElements(){this.observeLazyElements()}updateDOM(e,t="normal"){this.queueDOMUpdate(e,t)}updateData(e,t,a="text"){this.queueDataUpdate(e,t,a)}getPerformanceMetrics(){return{fps:this.fps,frameCount:this.frameCount,queueSize:this.domUpdateQueue.length,dataQueueSize:this.dataUpdateQueue.size,memory:performance.memory?{used:performance.memory.usedJSHeapSize,total:performance.memory.totalJSHeapSize,limit:performance.memory.jsHeapSizeLimit}:null}}optimize(){this.handleLowPerformance()}reset(){document.body.classList.remove("reduced-motion"),this.dataUpdateThrottle=100,document.querySelectorAll(".lottie-animation").forEach(e=>{e.lottieAnimation&&e.lottieAnimation.play()})}}class ResourceOptimizer{constructor(){this.preloadedResources=new Set,this.criticalResources=new Set,this.init()}init(){this.setupCriticalResourcePreloading(),this.setupImageOptimization(),this.setupFontOptimization(),this.setupScriptOptimization()}setupCriticalResourcePreloading(){[{href:"/css/site.min.css",as:"style"},{href:"/js/site.min.js",as:"script"},{href:"/js/dashboard.min.js",as:"script"},{href:"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap",as:"style"}].forEach(e=>{this.preloadResource(e.href,e.as)})}preloadResource(e,t,a=null){if(this.preloadedResources.has(e))return;const s=document.createElement("link");s.rel="preload",s.href=e,s.as=t,a&&(s.crossOrigin=a),document.head.appendChild(s),this.preloadedResources.add(e)}setupImageOptimization(){this.supportsWebP=this.checkWebPSupport(),this.supportsAVIF=this.checkAVIFSupport(),this.optimizeImages()}checkWebPSupport(){const e=document.createElement("canvas");return e.width=1,e.height=1,0===e.toDataURL("image/webp").indexOf("data:image/webp")}checkAVIFSupport(){const e=document.createElement("canvas");e.width=1,e.height=1;try{return 0===e.toDataURL("image/avif").indexOf("data:image/avif")}catch(e){return!1}}optimizeImages(){document.querySelectorAll("img").forEach(e=>{this.optimizeImage(e)})}optimizeImage(e){e.dataset.avif&&this.supportsAVIF?e.src=e.dataset.avif:e.dataset.webp&&this.supportsWebP&&(e.src=e.dataset.webp),e.hasAttribute("loading")||(e.loading="lazy"),e.decoding="async"}setupFontOptimization(){["https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2"].forEach(e=>{this.preloadResource(e,"font","anonymous")}),this.optimizeFontDisplay()}optimizeFontDisplay(){const e=document.createElement("style");e.textContent="\n            @font-face {\n                font-family: 'Inter';\n                font-display: swap;\n            }\n        ",document.head.appendChild(e)}setupScriptOptimization(){document.querySelectorAll("script[data-defer]").forEach(e=>{e.defer=!0}),this.setupModulePreloading()}setupModulePreloading(){["/js/dashboard.min.js","/js/accessibility.min.js","/js/mobile.min.js"].forEach(e=>{const t=document.createElement("link");t.rel="modulepreload",t.href=e,document.head.appendChild(t)})}}document.addEventListener("DOMContentLoaded",()=>{window.performanceOptimizer=new PerformanceOptimizer,window.resourceOptimizer=new ResourceOptimizer,console.log("Performance optimization initialized")}),window.PerformanceOptimizer=PerformanceOptimizer,window.ResourceOptimizer=ResourceOptimizer;